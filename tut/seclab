#!/usr/bin/env python3

import os
import sys
import glob
import subprocess

def usage():
    print("""
Usage: ./seclab [tut]

Examples:
    ./seclab tut01       : setup environment tut01
""")

if len(sys.argv) < 2:
    usage()
    sys.exit(1)

tut = sys.argv[1]
# Using f-strings (Python 3.6+) for cleaner string formatting
if len(glob.glob(f"/home/lab*/{tut}*")) == 0:
    print("[!] failed to locate the tutorial")
    sys.exit(2)

def set_aslr(n):
    # Use subprocess for better handling of shell commands
    cmd = f"echo {n} | sudo tee /proc/sys/kernel/randomize_va_space"
    subprocess.run(cmd, shell=True, check=True, stdout=subprocess.DEVNULL)

# Extract tutorial number
try:
    tut_num = int(tut[len("tut"):])
except ValueError:
    print("[!] Invalid tutorial format. Use 'tutXX'")
    sys.exit(1)

if tut_num <= 4:
    set_aslr(0)
else:
    set_aslr(2)

# Check for kernel module and load if missing
if not os.path.exists("/proc/flag"):
    print("[*] Building and loading kflag module...")

    # Define the specific compiler binary name the kernel expects
    EXPECTED_CC = "x86_64-linux-gnu-gcc-13"

    try:
        # Use 'cwd' to change directory instead of 'cd' inside a shell string
        subprocess.run(["make", f"CC={EXPECTED_CC}"], cwd="/home/vagrant/kflag", check=True)
        
        # Load the module
        subprocess.run(["sudo", "insmod", "/home/vagrant/kflag/kflag.ko"], check=True)
        
        print("[+] kflag module loaded successfully.")
    except subprocess.CalledProcessError as e:
        print(f"[-] Failed to build or load module: {e}")

print(f"[!] Ready for {tut}")
subprocess.run(["cat", "/proc/flag"])

